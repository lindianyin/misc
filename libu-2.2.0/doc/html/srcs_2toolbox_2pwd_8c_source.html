<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LibU: pwd.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Intro</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_000000.html">srcs</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_000001.html">toolbox</a>
  </div>
</div>
<div class="contents">
<h1>srcs/toolbox/pwd.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* </span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2005-2012 by KoanLogic s.r.l. - All rights reserved.  </span>
<a name="l00003"></a>00003 <span class="comment"> */</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;u/libu_conf.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;toolbox/hmap.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;toolbox/pwd.h&gt;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">/* in-memory db */</span>
<a name="l00013"></a>00013 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_new (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00014"></a>00014 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_term (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00015"></a>00015 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_load (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00016"></a>00016 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_push (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec);
<a name="l00017"></a>00017 <span class="keyword">static</span> <span class="keywordtype">void</span> __hmap_pwd_rec_free (<span class="keywordtype">void</span> *val);  <span class="comment">/* hook hmap free */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">/* misc */</span>
<a name="l00020"></a>00020 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_load (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00021"></a>00021 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_need_reload (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">/* u_pwd_rec_t */</span>
<a name="l00024"></a>00024 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_rec_new (<span class="keyword">const</span> <span class="keywordtype">char</span> *user, <span class="keyword">const</span> <span class="keywordtype">char</span> *pass, 
<a name="l00025"></a>00025         <span class="keyword">const</span> <span class="keywordtype">char</span> *opaque, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec);
<a name="l00026"></a>00026 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_retr_mem (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, 
<a name="l00027"></a>00027         <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec);
<a name="l00028"></a>00028 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_retr_res (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, 
<a name="l00029"></a>00029         <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec);
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">/* res ops */</span>
<a name="l00032"></a>00032 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_res_open (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00033"></a>00033 <span class="keyword">static</span> <span class="keywordtype">void</span> u_pwd_res_close (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/* file specialization */</span>
<a name="l00036"></a>00036 <span class="keyword">static</span> <span class="keywordtype">int</span> __file_open (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">void</span> **pfp);
<a name="l00037"></a>00037 <span class="keyword">static</span> <span class="keywordtype">void</span> __file_close (<span class="keywordtype">void</span> *fp);
<a name="l00038"></a>00038 <span class="keyword">static</span> <span class="keywordtype">char</span> *__file_load (<span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> size, <span class="keywordtype">void</span> *fp);
<a name="l00039"></a>00039 <span class="keyword">static</span> <span class="keywordtype">int</span> __file_notify (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, time_t last_update, 
<a name="l00040"></a>00040         time_t *pnew_update);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">/* a pwd instance context (will be passed along all u_pwd functions) */</span>
<a name="l00043"></a>00043 <span class="keyword">struct </span>u_pwd_s
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045     <span class="keywordtype">void</span> *res_handler;  <span class="comment">/* underlying storage resource: FILE*, io_t*, ... */</span>
<a name="l00046"></a>00046     <span class="keywordtype">char</span> res_uri[<a class="code" href="group__misc.html#gaed409a602e0a0bfbb13af6882ab893fa" title="Maximum length for a fully qualified file name.">U_FILENAME_MAX</a> + 1];
<a name="l00047"></a>00047 
<a name="l00048"></a>00048     <span class="keywordtype">size_t</span> hash_len;            <span class="comment">/* hash&#39;d password length */</span>
<a name="l00049"></a>00049     <a class="code" href="group__pwd.html#ga43eb981a4bdb2ef01de7c098af811839" title="Password hashing callback prototype: accept a string and its lenght, return the hashed...">u_pwd_hash_cb_t</a> cb_hash;    <span class="comment">/* hash function for password hiding */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051     <a class="code" href="group__pwd.html#ga30b3b0ecdad300ae09f8a22747912ab8" title="Master password DB open callback prototype: accepts an uri, return the (opaque) resource...">u_pwd_open_cb_t</a> cb_open;    <span class="comment">/* function for opening the db */</span>
<a name="l00052"></a>00052     <a class="code" href="group__pwd.html#ga0066b6c90ef073817e84c5f5ab275f8d" title="Record load callback prototype: has fgets(3)-like prototype with generic storage...">u_pwd_load_cb_t</a> cb_load;    <span class="comment">/* function for getting db records one by one */</span>
<a name="l00053"></a>00053     u_pwd_close_cb_t cb_close;  <span class="comment">/* function for opening the db */</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055     <a class="code" href="group__pwd.html#gaf5bd888cbff6cd0a1da01907e0069084" title="Update notification callback prototype: return true if supplied timestamp is older...">u_pwd_notify_cb_t</a> cb_notify;    <span class="comment">/* function for notifying changes in the </span>
<a name="l00056"></a>00056 <span class="comment">                                       master copy */</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     time_t last_mod;    <span class="comment">/* timestamp of master db&#39;s last update */</span>
<a name="l00059"></a>00059     <span class="keywordtype">int</span> in_memory;      <span class="comment">/* if set access is done via snapshot db */</span>
<a name="l00060"></a>00060     u_hmap_t *db;       <span class="comment">/* in-memory master db snapshot */</span>
<a name="l00061"></a>00061 };
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* each pwd line looks like this: &quot;&lt;user&gt;:&lt;password&gt;[:opaque]\n&quot;:</span>
<a name="l00064"></a>00064 <span class="comment"> * the following holds the line tokenization result */</span>
<a name="l00065"></a>00065 <span class="keyword">struct </span>u_pwd_rec_s
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067     <span class="keywordtype">char</span> *user;     <span class="comment">/* credential owner */</span>
<a name="l00068"></a>00068     <span class="keywordtype">char</span> *pass;     <span class="comment">/* password (hashed or cleartext) */</span>
<a name="l00069"></a>00069     <span class="keywordtype">char</span> *opaque;   <span class="comment">/* optional application specific data (e.g. PSK hint) */</span>
<a name="l00070"></a>00070 };
<a name="l00071"></a>00071 
<a name="l00161"></a><a class="code" href="group__pwd.html#ga2a6beedb54f220e5930524c3eb620e62">00161</a> <span class="keywordtype">int</span> <a class="code" href="group__pwd.html#ga2a6beedb54f220e5930524c3eb620e62" title="Initialize a pwd instance.">u_pwd_init</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *res_uri, <a class="code" href="group__pwd.html#ga30b3b0ecdad300ae09f8a22747912ab8" title="Master password DB open callback prototype: accepts an uri, return the (opaque) resource...">u_pwd_open_cb_t</a> cb_open, 
<a name="l00162"></a>00162         <a class="code" href="group__pwd.html#ga0066b6c90ef073817e84c5f5ab275f8d" title="Record load callback prototype: has fgets(3)-like prototype with generic storage...">u_pwd_load_cb_t</a> cb_load, u_pwd_close_cb_t cb_close, 
<a name="l00163"></a>00163         <a class="code" href="group__pwd.html#gaf5bd888cbff6cd0a1da01907e0069084" title="Update notification callback prototype: return true if supplied timestamp is older...">u_pwd_notify_cb_t</a> cb_notify, <a class="code" href="group__pwd.html#ga43eb981a4bdb2ef01de7c098af811839" title="Password hashing callback prototype: accept a string and its lenght, return the hashed...">u_pwd_hash_cb_t</a> cb_hash, 
<a name="l00164"></a>00164         <span class="keywordtype">size_t</span> hash_len, <span class="keywordtype">int</span> in_memory, <a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> **ppwd)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     <a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd;
<a name="l00167"></a>00167    
<a name="l00168"></a>00168     dbg_return_if (res_uri == NULL, ~0);
<a name="l00169"></a>00169     dbg_return_if (cb_open == NULL, ~0);
<a name="l00170"></a>00170     dbg_return_if (cb_load == NULL, ~0);
<a name="l00171"></a>00171     <span class="comment">/* cb_close is non-mandatory */</span>
<a name="l00172"></a>00172     <span class="comment">/* cb_notify is non-mandatory */</span>
<a name="l00173"></a>00173     dbg_return_if (cb_hash &amp;&amp; !hash_len, ~0);
<a name="l00174"></a>00174     dbg_return_if (ppwd == NULL, ~0);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="comment">/* make room for the instance context */</span>
<a name="l00177"></a>00177     pwd = <a class="code" href="group__alloc.html#gad508e24d765a79bd7e15feade062407c" title="Alloc a contiguous region of sz bytes and zero-fill it.">u_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a>));
<a name="l00178"></a>00178     dbg_err_sif (pwd == NULL);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* copy in supplied attributes and methods */</span>
<a name="l00181"></a>00181     pwd-&gt;res_handler = NULL;
<a name="l00182"></a>00182     dbg_err_if (<a class="code" href="group__misc.html#gaf0e76fa9fc95df1cfa45e4571d075270" title="Wrapper to strlcpy(3).">u_strlcpy</a>(pwd-&gt;res_uri, res_uri, <span class="keyword">sizeof</span> pwd-&gt;res_uri));
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     pwd-&gt;hash_len = hash_len;
<a name="l00185"></a>00185     pwd-&gt;cb_hash = cb_hash;
<a name="l00186"></a>00186     pwd-&gt;cb_open = cb_open;
<a name="l00187"></a>00187     pwd-&gt;cb_load = cb_load;
<a name="l00188"></a>00188     pwd-&gt;cb_close = cb_close;
<a name="l00189"></a>00189     pwd-&gt;cb_notify = cb_notify;
<a name="l00190"></a>00190     pwd-&gt;last_mod = 0;
<a name="l00191"></a>00191     pwd-&gt;in_memory = in_memory;
<a name="l00192"></a>00192     pwd-&gt;db = NULL;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">/* NOTE: don&#39;t load to memory if requested (i.e. .in_memory != 0) here:</span>
<a name="l00195"></a>00195 <span class="comment">     * it will be done at very first u_pwd_retr() via u_pwd_need_reload() */</span>
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     *ppwd = pwd;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">return</span> 0;
<a name="l00200"></a>00200 err:
<a name="l00201"></a>00201     <a class="code" href="group__pwd.html#ga953feb369ad87ac17aaca82541085c21" title="Dispose the supplied pwd instance.">u_pwd_term</a>(pwd);
<a name="l00202"></a>00202     <span class="keywordflow">return</span> ~0;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00219"></a><a class="code" href="group__pwd.html#ga9a1d5d9462850ec60a46e44bdba43b19">00219</a> <span class="keywordtype">int</span> <a class="code" href="group__pwd.html#ga9a1d5d9462850ec60a46e44bdba43b19" title="Retrieve a pwd record.">u_pwd_retr</a> (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     dbg_return_if (pwd == NULL, ~0);
<a name="l00222"></a>00222     dbg_return_if (user == NULL, ~0);
<a name="l00223"></a>00223     dbg_return_if (prec == NULL, ~0);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="comment">/* if in-memory snapshot is mantained, search there (in case on-storage</span>
<a name="l00226"></a>00226 <span class="comment">     * image has changed it will be resync&#39;d automatically) */</span>
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (pwd-&gt;in_memory)
<a name="l00228"></a>00228         <span class="keywordflow">return</span> u_pwd_retr_mem(pwd, user, prec);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">return</span> u_pwd_retr_res(pwd, user, prec);
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00246"></a><a class="code" href="group__pwd.html#ga16135e4c199535789903d4284a183f5f">00246</a> <span class="keywordtype">int</span> <a class="code" href="group__pwd.html#ga16135e4c199535789903d4284a183f5f" title="Check if user has presented the right credential.">u_pwd_auth_user</a> (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, <span class="keyword">const</span> <span class="keywordtype">char</span> *password)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     <span class="keywordtype">int</span> rc;
<a name="l00249"></a>00249     <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec = NULL;
<a name="l00250"></a>00250     <span class="keywordtype">char</span> *__p = NULL, __pstack[U_PWD_LINE_MAX];
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     dbg_return_if (password == NULL, ~0);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">/* retrieve the pwd record */</span>
<a name="l00255"></a>00255     dbg_err_if (<a class="code" href="group__pwd.html#ga9a1d5d9462850ec60a46e44bdba43b19" title="Retrieve a pwd record.">u_pwd_retr</a>(pwd, user, &amp;rec));
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">/* hash if requested, otherwise do cleartext cmp */</span>
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (pwd-&gt;cb_hash)
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260         <span class="comment">/* create a buffer that fits the specific hash function */</span>
<a name="l00261"></a>00261         dbg_err_if ((__p = <a class="code" href="group__alloc.html#gad508e24d765a79bd7e15feade062407c" title="Alloc a contiguous region of sz bytes and zero-fill it.">u_zalloc</a>(pwd-&gt;hash_len)) == NULL);
<a name="l00262"></a>00262         (void) pwd-&gt;cb_hash(password, strlen(password), __p);
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     <span class="keywordflow">else</span>
<a name="l00265"></a>00265     {
<a name="l00266"></a>00266         (void) <a class="code" href="group__misc.html#gaf0e76fa9fc95df1cfa45e4571d075270" title="Wrapper to strlcpy(3).">u_strlcpy</a>(__pstack, password, <span class="keyword">sizeof</span> __pstack);
<a name="l00267"></a>00267         __p = __pstack;
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     rc = strcmp(__p, rec-&gt;pass);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* free __p if on heap */</span>
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (__p &amp;&amp; (__p != __pstack))
<a name="l00274"></a>00274         <a class="code" href="group__alloc.html#ga8a480341289bf5fc1a72e7974c4a739d" title="Wrapper for free-like function, sanity checks the supplied pointer.">u_free</a>(__p);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="comment">/* rec ownership is ours only if hmap doesn&#39;t have it */</span>
<a name="l00277"></a>00277     <span class="keywordflow">if</span> (!pwd-&gt;in_memory)
<a name="l00278"></a>00278         <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordflow">return</span> rc;
<a name="l00281"></a>00281 err:
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (__p &amp;&amp; (__p != __pstack))
<a name="l00283"></a>00283         <a class="code" href="group__alloc.html#ga8a480341289bf5fc1a72e7974c4a739d" title="Wrapper for free-like function, sanity checks the supplied pointer.">u_free</a>(__p);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (!pwd-&gt;in_memory &amp;&amp; rec)
<a name="l00286"></a>00286         <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keywordflow">return</span> ~0;
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00300"></a><a class="code" href="group__pwd.html#ga953feb369ad87ac17aaca82541085c21">00300</a> <span class="keywordtype">void</span> <a class="code" href="group__pwd.html#ga953feb369ad87ac17aaca82541085c21" title="Dispose the supplied pwd instance.">u_pwd_term</a> (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302     nop_return_if (pwd == NULL, );
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     (void) u_pwd_db_term(pwd);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     U_FREE(pwd);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">return</span>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00327"></a><a class="code" href="group__pwd.html#gad3f849da69ab6f3aae9aa915d4a71699">00327</a> <span class="keywordtype">int</span> <a class="code" href="group__pwd.html#gad3f849da69ab6f3aae9aa915d4a71699" title="Init specialization for file-based password db.">u_pwd_init_file</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *res_uri, <a class="code" href="group__pwd.html#ga43eb981a4bdb2ef01de7c098af811839" title="Password hashing callback prototype: accept a string and its lenght, return the hashed...">u_pwd_hash_cb_t</a> cb_hash, 
<a name="l00328"></a>00328         <span class="keywordtype">size_t</span> hash_len, <span class="keywordtype">int</span> in_memory, <a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> **ppwd)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330     <span class="keywordflow">return</span> <a class="code" href="group__pwd.html#ga2a6beedb54f220e5930524c3eb620e62" title="Initialize a pwd instance.">u_pwd_init</a> (res_uri, __file_open, __file_load, __file_close, 
<a name="l00331"></a>00331         __file_notify, cb_hash, hash_len, in_memory, ppwd);
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00346"></a><a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e">00346</a> <span class="keywordtype">void</span> <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a> (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348     dbg_return_if (pwd == NULL, );
<a name="l00349"></a>00349     dbg_return_if (rec == NULL, );
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     U_FREE(rec-&gt;user);
<a name="l00352"></a>00352     U_FREE(rec-&gt;pass);
<a name="l00353"></a>00353     U_FREE(rec-&gt;opaque);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <a class="code" href="group__alloc.html#ga8a480341289bf5fc1a72e7974c4a739d" title="Wrapper for free-like function, sanity checks the supplied pointer.">u_free</a>(rec);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="keywordflow">return</span>;
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00370"></a><a class="code" href="group__pwd.html#ga5f2e179fad8d591ed47ab1a6fe65e9a6">00370</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__pwd.html#ga5f2e179fad8d591ed47ab1a6fe65e9a6" title="Return the user field of the supplied pwd record.">u_pwd_rec_get_user</a> (<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372     dbg_return_if (rec == NULL, NULL);
<a name="l00373"></a>00373     <span class="keywordflow">return</span> rec-&gt;user;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00386"></a><a class="code" href="group__pwd.html#ga7ac6de19c0c3e4e19ddaad68de295eda">00386</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__pwd.html#ga7ac6de19c0c3e4e19ddaad68de295eda" title="Return the password field of the supplied pwd record.">u_pwd_rec_get_password</a> (<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     dbg_return_if (rec == NULL, NULL);
<a name="l00389"></a>00389     <span class="keywordflow">return</span> rec-&gt;pass;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00401"></a><a class="code" href="group__pwd.html#ga763ca1a183471a7c47e8c9b964b58fb6">00401</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__pwd.html#ga763ca1a183471a7c47e8c9b964b58fb6" title="Return the opaque field of the supplied pwd record.">u_pwd_rec_get_opaque</a> (<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec)
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403     dbg_return_if (rec == NULL, NULL);
<a name="l00404"></a>00404     <span class="keywordflow">return</span> rec-&gt;opaque;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00417"></a><a class="code" href="group__pwd.html#ga4a2a646a3a22e3dad8d7df677874ec87">00417</a> <span class="keywordtype">int</span> <a class="code" href="group__pwd.html#ga4a2a646a3a22e3dad8d7df677874ec87" title="Return the in_memory attribute from the supplied pwd instance.">u_pwd_in_memory</a> (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00418"></a>00418 {
<a name="l00419"></a>00419     <span class="keywordflow">return</span> pwd-&gt;in_memory;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00426"></a>00426 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_load (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     dbg_return_if (pwd == NULL, ~0);
<a name="l00429"></a>00429     dbg_return_if (!pwd-&gt;in_memory, ~0);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="comment">/* wipe away old snapshot */</span>
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (pwd-&gt;db)
<a name="l00433"></a>00433         (void) u_pwd_db_term(pwd);
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     <span class="comment">/* create new hash map and load master db contents into it */</span>
<a name="l00436"></a>00436     dbg_err_if (u_pwd_db_new(pwd));
<a name="l00437"></a>00437     dbg_err_if (u_pwd_db_load(pwd));
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keywordflow">return</span> 0;
<a name="l00440"></a>00440 err:
<a name="l00441"></a>00441     <span class="keywordflow">return</span> ~0;
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_retr_res (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, 
<a name="l00445"></a>00445         <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447     <span class="keywordtype">size_t</span> lc, got_it = 0, ntoks;
<a name="l00448"></a>00448     <span class="keywordtype">char</span> ln[U_PWD_LINE_MAX], uu[U_PWD_LINE_MAX];
<a name="l00449"></a>00449     <span class="keywordtype">char</span> **toks = NULL;  <span class="comment">/* expected line fmt is: &quot;name:password[:opaque]\n&quot; */</span>
<a name="l00450"></a>00450     <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec = NULL;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     dbg_return_if (pwd-&gt;res_uri == NULL, ~0);
<a name="l00453"></a>00453     dbg_return_if (pwd-&gt;cb_load == NULL, ~0);
<a name="l00454"></a>00454     <span class="comment">/* cb_open consistency will be checked inside u_pwd_res_open */</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/* open master db */</span>
<a name="l00457"></a>00457     dbg_err_if (u_pwd_res_open(pwd));
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="comment">/* do suitable search string for strstr(3) */</span>
<a name="l00460"></a>00460     <a class="code" href="group__misc.html#ga1a0e41b455f71373a2ded5d9dfc52572" title="snprintf(3) wrapper">u_snprintf</a>(uu, <span class="keyword">sizeof</span> uu, <span class="stringliteral">&quot;%s:&quot;</span>, user);
<a name="l00461"></a>00461     
<a name="l00462"></a>00462     <span class="comment">/* read line by line */</span>
<a name="l00463"></a>00463     <span class="keywordflow">for</span> (lc = 1; pwd-&gt;cb_load(ln, <span class="keyword">sizeof</span> ln, pwd-&gt;res_handler) != NULL; lc++)
<a name="l00464"></a>00464     {
<a name="l00465"></a>00465         <span class="comment">/* skip comments */</span>
<a name="l00466"></a>00466         <span class="keywordflow">if</span> (ln[0] == <span class="charliteral">&#39;#&#39;</span>)
<a name="l00467"></a>00467             <span class="keywordflow">continue</span>;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="comment">/* check if we&#39;re on user line, in case break the read loop... </span>
<a name="l00470"></a>00470 <span class="comment">         * this is different from using the in-memory version in case an </span>
<a name="l00471"></a>00471 <span class="comment">         * entry is duplicated: in-memory matches the last entry, here</span>
<a name="l00472"></a>00472 <span class="comment">         * we would get the first one */</span>
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (strstr(ln, uu) == ln)
<a name="l00474"></a>00474         {
<a name="l00475"></a>00475             got_it = 1;
<a name="l00476"></a>00476             <span class="keywordflow">break</span>;
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="comment">/* check if we&#39;ve reached here due to simple loop exhaustion */</span>
<a name="l00481"></a>00481     dbg_err_ifm (!got_it, <span class="stringliteral">&quot;user %s not found&quot;</span>, user);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="comment">/* remove terminating \n if needed */</span>
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (ln[strlen(ln) - 1] == <span class="charliteral">&#39;\n&#39;</span>)
<a name="l00485"></a>00485         ln[strlen(ln) - 1] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="comment">/* tokenize line: expect at least 2 fields: user and password */</span>
<a name="l00488"></a>00488     dbg_err_ifm (<a class="code" href="group__misc.html#gaac2606061064e492c8eadd5e641b07dc" title="Break a string into pieces separated by a given set of characters.">u_strtok</a>(ln, <span class="stringliteral">&quot;:&quot;</span>, &amp;toks, &amp;ntoks) || ntoks &lt; 2,
<a name="l00489"></a>00489             <span class="stringliteral">&quot;bad syntax at line %zu (%s)&quot;</span>, lc, ln);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">/* create new record */</span>
<a name="l00492"></a>00492     dbg_err_if (u_pwd_rec_new(toks[0], toks[1], ntoks &lt; 3 ? NULL : toks[2], 
<a name="l00493"></a>00493                 &amp;rec));
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="comment">/* dispose u_strtok rubbish */</span>
<a name="l00496"></a>00496     <a class="code" href="group__misc.html#gaaa2f98b4387a5d48da5b1d20152a416f" title="Cleanup the strings vector created by u_strtok.">u_strtok_cleanup</a>(toks, ntoks);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">/* dispose resource handler (if a &#39;close&#39; method has been set) */</span>
<a name="l00499"></a>00499     u_pwd_res_close(pwd);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="comment">/* copy out */</span>
<a name="l00502"></a>00502     *prec = rec;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordflow">return</span> 0;
<a name="l00505"></a>00505 err:
<a name="l00506"></a>00506     <span class="keywordflow">if</span> (rec)
<a name="l00507"></a>00507         <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="keywordflow">if</span> (toks)
<a name="l00510"></a>00510         <a class="code" href="group__misc.html#gaaa2f98b4387a5d48da5b1d20152a416f" title="Cleanup the strings vector created by u_strtok.">u_strtok_cleanup</a>(toks, ntoks);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     u_pwd_res_close(pwd);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <span class="keywordflow">return</span> ~0;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_res_open (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519     dbg_return_if (pwd-&gt;cb_open == NULL, ~0);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">if</span> (pwd-&gt;res_handler != NULL)
<a name="l00522"></a>00522         u_warn(<span class="stringliteral">&quot;non-NULL resource handler will be lost&quot;</span>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     pwd-&gt;res_handler = NULL;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     <span class="keywordflow">return</span> pwd-&gt;cb_open(pwd-&gt;res_uri, &amp;pwd-&gt;res_handler);
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="keyword">static</span> <span class="keywordtype">void</span> u_pwd_res_close (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     nop_return_if (pwd-&gt;res_handler == NULL, );
<a name="l00532"></a>00532     nop_return_if (pwd-&gt;cb_close == NULL, );
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     pwd-&gt;cb_close(pwd-&gt;res_handler);
<a name="l00535"></a>00535     pwd-&gt;res_handler = NULL;
<a name="l00536"></a>00536     
<a name="l00537"></a>00537     <span class="keywordflow">return</span>;
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_rec_new (<span class="keyword">const</span> <span class="keywordtype">char</span> *user, <span class="keyword">const</span> <span class="keywordtype">char</span> *pass, 
<a name="l00541"></a>00541         <span class="keyword">const</span> <span class="keywordtype">char</span> *opaque, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec)
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543     <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec = NULL;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     dbg_return_if (user == NULL, ~0);
<a name="l00546"></a>00546     dbg_return_if (pass == NULL, ~0);
<a name="l00547"></a>00547     dbg_return_if (prec == NULL, ~0);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     rec = <a class="code" href="group__alloc.html#gad508e24d765a79bd7e15feade062407c" title="Alloc a contiguous region of sz bytes and zero-fill it.">u_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a>));
<a name="l00550"></a>00550     dbg_err_sif (rec == NULL);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     rec-&gt;user = <a class="code" href="group__misc.html#gae52a8784cc2099cbe1d700557daec2a6" title="Allocate sufficient memory for a copy of the supplied string, copy it, and return...">u_strdup</a>(user);
<a name="l00553"></a>00553     dbg_err_sif (rec-&gt;user == NULL);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     rec-&gt;pass = <a class="code" href="group__misc.html#gae52a8784cc2099cbe1d700557daec2a6" title="Allocate sufficient memory for a copy of the supplied string, copy it, and return...">u_strdup</a>(pass);
<a name="l00556"></a>00556     dbg_err_sif (rec-&gt;pass == NULL);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="comment">/* opaque field may be NULL */</span>
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (opaque)
<a name="l00560"></a>00560     {
<a name="l00561"></a>00561         rec-&gt;opaque = <a class="code" href="group__misc.html#gae52a8784cc2099cbe1d700557daec2a6" title="Allocate sufficient memory for a copy of the supplied string, copy it, and return...">u_strdup</a>(opaque);
<a name="l00562"></a>00562         dbg_err_sif (rec-&gt;opaque == NULL);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     *prec = rec;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">return</span> 0;
<a name="l00568"></a>00568 err:
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (rec)
<a name="l00570"></a>00570     {
<a name="l00571"></a>00571         U_FREE(rec-&gt;user);
<a name="l00572"></a>00572         U_FREE(rec-&gt;pass);
<a name="l00573"></a>00573         U_FREE(rec-&gt;opaque);
<a name="l00574"></a>00574         <a class="code" href="group__alloc.html#ga8a480341289bf5fc1a72e7974c4a739d" title="Wrapper for free-like function, sanity checks the supplied pointer.">u_free</a>(rec);
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     <span class="keywordflow">return</span> ~0;
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_retr_mem (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *user, 
<a name="l00580"></a>00580         <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> **prec)
<a name="l00581"></a>00581 {
<a name="l00582"></a>00582     <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *pr = NULL;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     dbg_return_if (pwd == NULL, ~0);
<a name="l00585"></a>00585     dbg_return_if (user == NULL, ~0);
<a name="l00586"></a>00586     dbg_return_if (prec == NULL, ~0);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="comment">/* on error keep on working with the old in-memory db */</span>
<a name="l00589"></a>00589     dbg_ifb (u_pwd_need_reload(pwd))
<a name="l00590"></a>00590         u_warn(&quot;error reloading master pwd file: using stale cache&quot;);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     dbg_err_if (pwd-&gt;db == NULL);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     pr = (<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *) <a class="code" href="group__hmap.html#ga36373399a1696da46e42030fd8ad6f2e" title="Retrieve a value from the hmap.">u_hmap_easy_get</a>(pwd-&gt;db, user);
<a name="l00595"></a>00595     dbg_err_if (pr == NULL);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     *prec = pr;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     return 0;
<a name="l00600"></a>00600 err:
<a name="l00601"></a>00601     return ~0;
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 static <span class="keywordtype">int</span> u_pwd_need_reload (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00605"></a>00605 {
<a name="l00606"></a>00606     time_t update_timestamp;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="comment">/* if needed parameters are not set return immediately (no error) */</span>
<a name="l00609"></a>00609     nop_return_if (!pwd-&gt;in_memory, 0);
<a name="l00610"></a>00610     nop_return_if (pwd-&gt;cb_notify == NULL, 0);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="comment">/* in case no update has been notified return */</span>
<a name="l00613"></a>00613     <span class="keywordflow">if</span> (!pwd-&gt;cb_notify(pwd-&gt;res_uri, pwd-&gt;last_mod, &amp;update_timestamp))
<a name="l00614"></a>00614         <span class="keywordflow">return</span> 0;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="comment">/* update notified: set .last_mod */</span>
<a name="l00617"></a>00617     pwd-&gt;last_mod = update_timestamp;
<a name="l00618"></a>00618     
<a name="l00619"></a>00619     <span class="comment">/* reload db to memory */</span>
<a name="l00620"></a>00620     <span class="keywordflow">return</span> u_pwd_load(pwd);
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_new (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625     u_hmap_opts_t *hopts = NULL;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     dbg_err_if (pwd == NULL);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     dbg_err_if (<a class="code" href="group__hmap.html#ga42280b06bb117f1cbc0e9b8b8e19e753" title="Create new hmap options.">u_hmap_opts_new</a>(&amp;hopts));
<a name="l00630"></a>00630     dbg_err_if (<a class="code" href="group__hmap.html#gaa9e66fa5db06dc53066258629dc8d551" title="Set free function for values.">u_hmap_opts_set_val_freefunc</a>(hopts, &amp;__hmap_pwd_rec_free));
<a name="l00631"></a>00631             
<a name="l00632"></a>00632     <span class="keywordflow">return</span> <a class="code" href="group__hmap.html#ga75da31cb0cba2f848637cfd56fbc3748" title="Create a new hmap.">u_hmap_easy_new</a>(hopts, &amp;pwd-&gt;db);
<a name="l00633"></a>00633 err:
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (hopts)
<a name="l00635"></a>00635         <a class="code" href="group__hmap.html#gab3c9ffa54ef385371bac4bd60bbe3c6d" title="Deallocate hmap options.">u_hmap_opts_free</a>(hopts);
<a name="l00636"></a>00636     <span class="keywordflow">return</span> ~0;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_term (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00640"></a>00640 {
<a name="l00641"></a>00641     dbg_return_if (pwd == NULL, ~0);
<a name="l00642"></a>00642         
<a name="l00643"></a>00643     nop_return_if (pwd-&gt;db == NULL, 0);
<a name="l00644"></a>00644             
<a name="l00645"></a>00645     <a class="code" href="group__hmap.html#gaae4f0f0846e498dcc4b2fd094f22fff5" title="Deallocate hmap.">u_hmap_easy_free</a>(pwd-&gt;db);
<a name="l00646"></a>00646     pwd-&gt;db = NULL;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     <span class="keywordflow">return</span> 0;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_load (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653     <span class="keywordtype">size_t</span> lc, ntoks;
<a name="l00654"></a>00654     <span class="keywordtype">char</span> ln[U_PWD_LINE_MAX];
<a name="l00655"></a>00655     <span class="keywordtype">char</span> **toks = NULL;  <span class="comment">/* line fmt is: &quot;name:password[:hint]\n&quot; */</span>
<a name="l00656"></a>00656     <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec = NULL;
<a name="l00657"></a>00657     
<a name="l00658"></a>00658     dbg_return_if (pwd-&gt;res_uri == NULL, ~0);
<a name="l00659"></a>00659     dbg_return_if (pwd-&gt;cb_load == NULL, ~0);
<a name="l00660"></a>00660     <span class="comment">/* cb_open and cb_close will be checked inside u_pwd_res_{open,close} */</span>
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="comment">/* open master db */</span>
<a name="l00663"></a>00663     dbg_err_if (u_pwd_res_open(pwd));
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">for</span> (lc = 1; pwd-&gt;cb_load(ln, <span class="keyword">sizeof</span> ln, pwd-&gt;res_handler) != NULL; lc++)
<a name="l00666"></a>00666     {
<a name="l00667"></a>00667         <span class="comment">/* cleanup strtok rubbish from the previous loop */</span>
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (toks)
<a name="l00669"></a>00669         {
<a name="l00670"></a>00670             <a class="code" href="group__misc.html#gaaa2f98b4387a5d48da5b1d20152a416f" title="Cleanup the strings vector created by u_strtok.">u_strtok_cleanup</a>(toks, ntoks);
<a name="l00671"></a>00671             toks = NULL;
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         <span class="comment">/* skip comment lines */</span>
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (ln[0] == <span class="charliteral">&#39;#&#39;</span>)
<a name="l00676"></a>00676             <span class="keywordflow">continue</span>;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         <span class="comment">/* remove trailing \n */</span>
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (ln[strlen(ln) - 1] == <span class="charliteral">&#39;\n&#39;</span>)
<a name="l00680"></a>00680             ln[strlen(ln) - 1] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <span class="comment">/* tokenize line */</span>
<a name="l00683"></a>00683         dbg_ifb (<a class="code" href="group__misc.html#gaac2606061064e492c8eadd5e641b07dc" title="Break a string into pieces separated by a given set of characters.">u_strtok</a>(ln, <span class="stringliteral">&quot;:&quot;</span>, &amp;toks, &amp;ntoks) || ntoks &lt; 2)
<a name="l00684"></a>00684         {
<a name="l00685"></a>00685             u_info(<span class="stringliteral">&quot;bad syntax at line %zu (%s)&quot;</span>, lc, ln);
<a name="l00686"></a>00686             <span class="keywordflow">continue</span>;
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         <span class="comment">/* create u_pwd_rec_t from tokens */</span>
<a name="l00690"></a>00690         dbg_ifb (u_pwd_rec_new(toks[0], toks[1], ntoks &lt; 3 ? NULL : toks[2], 
<a name="l00691"></a>00691                     &amp;rec))
<a name="l00692"></a>00692         {
<a name="l00693"></a>00693             u_info(<span class="stringliteral">&quot;could not create record for entry at line %zu&quot;</span>, lc);
<a name="l00694"></a>00694             <span class="keywordflow">continue</span>;
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697         <span class="comment">/* push rec to db */</span>
<a name="l00698"></a>00698         dbg_ifb (u_pwd_db_push(pwd, rec))
<a name="l00699"></a>00699         {
<a name="l00700"></a>00700             u_info(<span class="stringliteral">&quot;could not push record for entry at line %zu&quot;</span>, lc);
<a name="l00701"></a>00701             <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec), rec = NULL;
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         rec = NULL;
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (toks)
<a name="l00708"></a>00708         <a class="code" href="group__misc.html#gaaa2f98b4387a5d48da5b1d20152a416f" title="Cleanup the strings vector created by u_strtok.">u_strtok_cleanup</a>(toks, ntoks);
<a name="l00709"></a>00709  
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (rec)
<a name="l00711"></a>00711         <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     u_pwd_res_close(pwd);
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     <span class="keywordflow">return</span> 0;
<a name="l00716"></a>00716 err:
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (rec)
<a name="l00718"></a>00718         <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(pwd, rec);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (toks)
<a name="l00721"></a>00721         <a class="code" href="group__misc.html#gaaa2f98b4387a5d48da5b1d20152a416f" title="Cleanup the strings vector created by u_strtok.">u_strtok_cleanup</a>(toks, ntoks);
<a name="l00722"></a>00722  
<a name="l00723"></a>00723     u_pwd_res_close(pwd);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="keywordflow">return</span> ~0;
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 <span class="keyword">static</span> <span class="keywordtype">int</span> u_pwd_db_push (<a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> *pwd, <a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *rec)
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730     dbg_return_if (pwd-&gt;db == NULL, ~0);
<a name="l00731"></a>00731     dbg_return_if (rec == NULL, ~0);
<a name="l00732"></a>00732     dbg_return_if (rec-&gt;user == NULL, ~0);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordflow">return</span> <a class="code" href="group__hmap.html#gab2a63315f21a7e74fb5d0ca2d1bc1ed3" title="Insert an object into the hmap.">u_hmap_easy_put</a>(pwd-&gt;db, rec-&gt;user, (<span class="keyword">const</span> <span class="keywordtype">void</span> *) rec);
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <span class="comment">/* </span>
<a name="l00738"></a>00738 <span class="comment"> * prefabricated callbacks</span>
<a name="l00739"></a>00739 <span class="comment"> */</span>
<a name="l00740"></a>00740 <span class="keyword">static</span> <span class="keywordtype">int</span> __file_open (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">void</span> **pfp)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742     FILE *fp = NULL;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     dbg_err_sif ((fp = fopen(path, <span class="stringliteral">&quot;r&quot;</span>)) == NULL);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     *pfp = (<span class="keywordtype">void</span> *) fp;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keywordflow">return</span> 0;
<a name="l00749"></a>00749 err:
<a name="l00750"></a>00750     <span class="keywordflow">return</span> ~0;
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 <span class="keyword">static</span> <span class="keywordtype">void</span> __file_close (<span class="keywordtype">void</span> *fp)
<a name="l00754"></a>00754 {
<a name="l00755"></a>00755     dbg_return_sif (fclose((FILE *) fp), <span class="comment">/* nothing */</span>);
<a name="l00756"></a>00756     <span class="keywordflow">return</span>;
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 <span class="keyword">static</span> <span class="keywordtype">char</span> *__file_load (<span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> size, <span class="keywordtype">void</span> *fp)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761     <span class="keywordflow">return</span> fgets(str, size, (FILE *) fp);
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="comment">/* in case file update has been detected, *pnew_update is also set */</span>
<a name="l00765"></a>00765 <span class="keyword">static</span> <span class="keywordtype">int</span> __file_notify (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, time_t last_update, 
<a name="l00766"></a>00766         time_t *pnew_update)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768     <span class="keyword">struct </span>stat sb;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     dbg_err_if (path == NULL);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     dbg_err_sif (stat(path, &amp;sb));
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (sb.st_ctime != last_update)
<a name="l00775"></a>00775     {
<a name="l00776"></a>00776         *pnew_update = sb.st_ctime;
<a name="l00777"></a>00777         <span class="keywordflow">return</span> 1;
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="comment">/* fall through (return false) */</span>
<a name="l00781"></a>00781 err:
<a name="l00782"></a>00782     <span class="keywordflow">return</span> 0;
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 <span class="comment">/* hmap glue */</span>
<a name="l00786"></a>00786 <span class="keyword">static</span> <span class="keywordtype">void</span> __hmap_pwd_rec_free (<span class="keywordtype">void</span> *val)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788     <a class="code" href="group__pwd.html#ga95bdb8d39873ee3b16a27fd3665ea41c" title="default length of a password file line (can be changed at compile time via -DU_PWD_LINE_MAX=nnn...">u_pwd_t</a> fake_pwd;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     fake_pwd.in_memory = 1;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     <a class="code" href="group__pwd.html#ga05ce71b28ee2271281fe4efcbfd6675e" title="Dispose a u_pwd_rec_t object.">u_pwd_rec_free</a>(&amp;fake_pwd, (<a class="code" href="group__pwd.html#gad545d5fc0c65eb34fba6713d3ae430fc" title="Carry information about a single password DB record.">u_pwd_rec_t</a> *) val);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="keywordflow">return</span>;
<a name="l00795"></a>00795 }
</pre></div></div>
<hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2012 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
